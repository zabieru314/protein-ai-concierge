# modules/nutrition_data.py

NUTRITION_TIPS = {
    "general": {
        "title": "一般的なタンパク質摂取量",
        "template": (
            "ちなみに、ご存知でしたか？ 一般的に、健康維持のための1日のタンパク質推奨量は、体重1kgあたり約1.0gと言われています。"
            "例えば、平均的な体重の65kgの方なら、1日に65gのタンパク質が必要という計算になります。"
            "もし、1回の食事で20gのタンパク質が摂れるとすると、残りの45gをプロテインなどで賢く補うのが、理想的な栄養バランスへの近道ですよ。"
        )
    },
    "for_bulk_up": {
        "title": "筋肉を大きくしたい方向け",
        "template": (
            "筋肉を大きくしたいあなたに、一つ豆知識です！"
            "本格的にトレーニングをする方は、体重1kgあたり2.0gのタンパク質摂取が推奨されています。"
            "例えば、体重70kgの方なら、なんと1日に140gものタンパク質が必要になるんです。"
            "1回の食事で25g摂れたとしても、残りの115gを食事だけで補うのは大変ですよね。だからこそ、トレーニング後のプロテインが、目標達成のための強力な味方になるんです。"
        )
    },
    "for_diet": {
        "title": "ダイエット・引き締めたい方向け",
        "template": (
            "ダイエット中のあなたに、ぜひ知っておいてほしい豆知識があります。"
            "実は、ダイエット中でも筋肉を落tさないために、体重1kgあたり1.2gのタンパク質をしっかり摂ることが大切なんです。"
            "例えば、体重55kgの方なら、66gは必要になります。"
            "特に、食事制限で不足しがちな分をプロテインで補うと、満足感も得られて、キレイな体づくりに繋がりますよ。"
        )
    },
    "PricePerKg(JPY)": {
        "title": "コストパフォーマンスに関する豆知識",
        "template": (
            "プロテインの価格について、一つ面白い豆知識があります。"
            "実は、プロテインの価格は、ブランドや原材料だけでなく、**パッケージの容量**によっても大きく変わるんです。"
            "一般的に、1kgのパッケージよりも3kgや5kgといった大容量のパッケージの方が、1kgあたりの価格（コストパフォーマンス）は劇的に良くなることが多いんですよ。もしお気に入りのプロテインが見つかったら、次は大容量サイズを検討してみるのも賢い選択です。"
        )
    },
    "Taste": {
        "title": "プロテインの味に関する豆知識",
        "template": (
            "プロテインの「味」について、一つ豆知識です！"
            "味を左右するのはフレーバーだけでなく、ベースとなる**原料（ホエイかソイかなど）**も大きく影響するんです。"
            "一般的に、牛乳由来の「ホエイプロテイン」はクリーミーで飲みやすく、大豆由来の「ソイプロテイン」は少し素朴で、腹持ちが良いのが特徴です。もし今のプロテインの味が合わないと感じたら、次はベースの原料を変えてみるのも面白いかもしれませんよ。"
        )
    },
    "ProteinPerServing(g)": {
        "title": "タンパク質含有率に関する豆知識",
        "template": (
            "タンパク質の「質」を重視するあなたに、ぜひ知っておいてほしい豆知識があります。"
            "プロテインには主に**WPC**と**WPI**という種類があるのをご存知でしたか？"
            "WPIは、一般的なWPCからさらに脂質や乳糖などを取り除いた、より高純度なプロテインなんです。そのため、タンパク質含有率が非常に高く、お腹がゴロゴロしやすい方にもおすすめと言われています。少し価格は高めですが、品質を追求するなら、WPIと書かれた商品を探してみる価値はありますよ。"
        )
    }
}

def get_formatted_nutrition_tip(intent: dict) -> str:
    """
    ユーザーの意図(intent)を分析し、最適な豆知識テキストを返す関数。
    """
    key_metric = intent.get("key_metric", "general")
    relevant_tags = intent.get("relevant_tags", [])
    
    tip_id = "general" # デフォルト
    
    # まず、key_metricが豆知識DBに存在するかチェック
    if key_metric in NUTRITION_TIPS:
        tip_id = key_metric
    
    # 次に、タグによる上書きを試みる（より具体的な意図を優先）
    if "#増量" in relevant_tags or "#バルクアップ" in relevant_tags:
        tip_id = "for_bulk_up"
    elif "#減量" in relevant_tags or "#ダイエット" in relevant_tags or "#引き締め" in relevant_tags:
        tip_id = "for_diet"
    
    # 選択したIDを元に、豆知識テキストを取得
    return NUTRITION_TIPS.get(tip_id, NUTRITION_TIPS["general"])["template"]