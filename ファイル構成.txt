

---

## AIプロテインアドバイザー『Synapse』プロジェクト概要 (最終版)

### 1. プロジェクトの目的 (What is this?)

このプロジェクトは、AIとの「本物の対話」を通じて、ユーザーが自分自身の価値観を発見し、それに最適な商品を自ら選び取れるように支援する、次世代のAIエージェント・コマースプラットフォームです。

最大の特徴は、AIの役割を**「分析官」**と**「コピーライター」**に完全に分離した**2コール構成**を採用している点です。これにより、ユーザーの曖昧な要望を正確に構造化データへ変換し、そのデータに基づいて人間味あふれる豊かな対話を生成するという、高度な情報処理と高品質なユーザー体験を両立させています。

### 2. ファイル構成 (How is it structured?)

現在のプロジェクトは、責務が明確に分離された、以下のファイルとディレクトリによって構成されています。

```
synapse_mvp/
├── .gitignore               # (Gitで管理しないファイルを指定)
├── .streamlit/              # (Streamlitアプリ固有の設定フォルダ)
│   └── secrets.toml         #  - APIキーなどの秘密情報を保管
├── app.py                   # ★ 司令塔 (アプリケーション全体の流れを制御)
├── modules/                 # ★ 専門家集団 (各機能の専門家)
│   ├── __init__.py          #  - (Pythonのモジュールとして認識させるための空ファイル)
│   ├── chat_handler.py      #  - 対話と論理の専門家 (アプリケーションの頭脳)
│   ├── gemini_client.py     #  - AI通信の専門家 (2種類のAIとの通信を担当)
│   ├── google_sheets_client.py # - データベースの専門家
│   └── ui_components.py     #  - UIの専門家 (画面描画の全てを担当)
├── prompts/                 # ★ AIの魂 (2種類のAIの思考回路)
│   ├── system_prompt_analyzer.txt # - AI分析官の思考回路
│   └── system_prompt_writer.txt   # - AIコピーライターの思考回路
├── credentials.json         # (Google Sheetsへのアクセス認証情報)
├── requirements.txt         # (プロジェクトに必要なライブラリ一覧)
└── README.md                # (プロジェクトの説明書)
```

### 3. 各ファイルの役割と連携 (How do they work together?)

このアプリケーションは、各ファイルが明確な役割を持つ「専門家集団」として、互いに連携して動作します。

#### `app.py` - 司令塔 (The Commander)
*   **役割:** アプリケーションの**エントリーポイント**であり、全体の流れを制御する、最もシンプルな**司令塔**です。このファイルは、今後ほとんど変更する必要がありません。
*   **動作:**
    1.  起動時に、`google_sheets_client`を使ってデータベースを読み込み、`initialize_session_state`でセッションを初期化します。
    2.  `st.session_state.diagnosis_complete`の値に基づき、「診断画面」を表示するか、「チャット画面」を表示するかを決定します。
    3.  **診断画面の場合:** `ui_components.render_diagnosis_form()`を呼び出し、画面描画の全てを委任します。
    4.  **チャット画面の場合:** `ui_components.render_chat_interface()`を呼び出し、画面描画を委任します。もしユーザーからの新しい入力(`prompt`)があれば、それを`chat_handler.handle_chat_prompt()`に渡し、AIとの対話処理の全てを委任します。

#### `modules/` - 専門家集団 (The Specialists)

##### `ui_components.py` - UIの専門家 (The UI Specialist)
*   **役割:** ユーザーがブラウザで見る**全ての画面要素を描画する**ことだけに責任を持ちます。レイアウトの変更や文言の修正は、このファイルだけで完結します。
*   **動作:**
    *   `render_diagnosis_form()`: ペルソナ診断のフォームやボタンを描画します。
    *   `render_chat_interface()`: チャット履歴をループで表示し、AIの応答に含まれる「見えないインク（HTMLコメント）」を読み取って、対応する画像やリンク、性能比較表などを適切な場所に描画します。最後にチャット入力欄を表示し、ユーザーからの新しい入力を`app.py`に返します。

##### `chat_handler.py` - 対話と論理の専門家 (The Brain)
*   **役割:** このアプリケーションの**「頭脳」**です。ユーザーからのプロンプトを受け取り、AIとの対話、データ分析、商品選定といった、**アプリケーションの核となる思考ロジック**の全てを実行します。
*   **動作 (一連の流れ):**
    1.  `app.py`から`prompt`を受け取ります。
    2.  ユーザーの入力を`st.session_state.messages`に追加します。
    3.  **【1コール目】** `gemini_client.get_intent_from_ai()`を呼び出し、AI分析官にユーザーの意図をJSON形式で分析させます。
    4.  返ってきたJSONを解析し、`key_metric`（例: `Taste`）を特定します。
    5.  Pandasを駆使して、データベースから`key_metric`に最適な商品を**プログラム的に**2つ選び出します。この際、「タンパク質含有率」などの新しい指標も動的に計算します。
    6.  **【2コール目】** `gemini_client.get_ai_response_writer()`を呼び出し、AIコピーライターに、選定理由や商品データを渡して、人間味のある応答文をストリーミングで生成させます。
    7.  生成された応答と、比較表用のデータを`st.session_state`に保存します。
    8.  最後に`st.rerun()`を呼び出し、`ui_components.py`が更新された情報を元に、最終的な画面を描画できるようにします。

##### `gemini_client.py` - AI通信の専門家 (The Communicator)
*   **役割:** GoogleのGemini APIとの**全ての通信**を専門に担当します。AIのAPIキー設定やモデルの初期化もここで行います。
*   **動作:**
    *   `get_intent_from_ai()`: `system_prompt_analyzer.txt`を読み込み、AI分析官を呼び出して、JSON文字列を返します。
    *   `get_ai_response_writer()`: `system_prompt_writer.txt`を読み込み、`chat_handler.py`から渡された複数の情報（選定理由、商品データなど）をプロンプトに埋め込み、AIコピーライターを呼び出して、応答をストリーミングで返します。

##### `google_sheets_client.py` - データベースの専門家 (The Librarian)
*   **役割:** Googleスプレッドシート（私たちのデータベース）との通信を専門に担当します。
*   **動作:** `get_all_records()`が呼び出されると、認証情報を元にスプレッドシートに接続し、全てのプロテインデータを取得して、Pandas DataFrameの形式で返します。

#### `prompts/` - AIの魂 (The Soul)
*   **`system_prompt_analyzer.txt`:** AI分析官の思考回路です。ユーザーの自然言語を、プログラムが処理可能なJSONに変換するための、厳格なルールと具体例が記述されています。
*   **`system_prompt_writer.txt`:** AIコピーライターの思考回路です。`chat_handler.py`から渡された構造化データと文脈（選定理由など）を元に、人間らしく、共感的で、そして説得力のある文章を生成するための、詳細な指示と対話戦略が記述されています。

---

この責務が明確に分離されたアーキテクチャにより、各ファイルは自身の役割に集中でき、変更やデバッグが非常に容易な、メンテナンス性と拡張性の高いプロジェクトが実現されています。