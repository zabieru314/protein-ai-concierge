## AIプロテインアドバイザー『Synapse』プロジェクト概要 (最終版)

### 1. プロジェクトの目的 (What is this?)

このプロジェクトは、AIとの「本物の対話」を通じて、ユーザーが自分自身の価値観を発見し、それに最適な商品を自ら選び取れるように支援する、次世代のAIエージェント・コマースプラットフォームです。

最大の特徴は、AIの役割を**「分析官」**と**「コピーライター」**に完全に分離した**2コール構成**を採用している点です。これにより、ユーザーの曖昧な要望を正確に構造化データへ変換し、そのデータに基づいて人間味あふれる豊かな対話を生成するという、高度な情報処理と高品質なユーザー体験を両立させています。

### 2. ファイル構成 (How is it structured?)

リファクタリング後の現在のプロジェクトは、各機能が専門家として完全に独立した、以下のファイルとディレクトリによって構成されています。

```
synapse_mvp/
├── .streamlit/
│   └── secrets.toml         #  - APIキーなどの秘密情報を保管
├── app.py                   # ★★★ 全てのエントリーポイントとなる最高司令塔
├── modules/                 # ★★★ 高度に専門化されたプロフェッショナル集団
│   ├── __init__.py
│   ├── chat_handler.py      #  - 司令塔 (対話フロー全体の指揮官)
│   ├── gemini_client.py     #  - AI通信の専門家
│   ├── google_sheets_client.py # - データベースの専門家
│   ├── ui_components.py     #  - UIの専門家
│   │
│   ├── formatters.py        #  - テキスト整形職人 (New!)
│   ├── nutrition_data.py    #  - 豆知識の司書 (New!)
│   └── protein_selector.py  #  - データ分析官 (New!)
│
├── prompts/                 # ★ AIの魂 (2種類のAIの思考回路)
│   ├── system_prompt_analyzer.txt # - AI分析官の思考回路
│   └── system_prompt_writer.txt   # - AIコピーライターの思考回路
│
├── credentials.json         # (【ローカル開発用】Google Sheetsへのアクセス認証情報)
├── requirements.txt         # (プロジェクトに必要なライブラリ一覧)
└── README.md                # (プロジェクトの説明書)
```

### 3. 各ファイルの役割と連携 (How do they work together?)

このアプリケーションは、かつての「万能な頭脳」を解体し、各ファイルが明確な役割を持つ**「専門家集団」**として、互いに連携して動作する、より高度なアーキテクチャに進化しました。

#### `app.py` - 最高司令塔 (The Supreme Commander)
*   **役割:** アプリケーションの**唯一のエントリーポイント**です。全体の流れを制御するだけで、具体的な処理は一切行いません。
*   **動作:**
    1.  起動時に、`google_sheets_client`を使ってデータベースを読み込みます。
    2.  `st.session_state`（セッション状態）に基づき、「診断画面」か「チャット画面」の表示を決定します。
    3.  ユーザーからの新しい入力があれば、それを`chat_handler`に渡し、**以降のすべての処理を完全に委任**します。

#### `modules/` - 専門家集団 (The Specialists)

##### `chat_handler.py` - 司令塔 (The Commander)
*   **役割:** かつての「頭脳」から、各専門家を適切な順序で呼び出し、処理の流れを指揮する**「司令塔」**へとスリム化されました。このファイルを見れば、アプリケーションがどのような手順で思考しているかが一目瞭然です。
*   **動作 (一連の流れ):**
    1.  `app.py`からユーザープロンプトを受け取ります。
    2.  **【専門家召喚①】** `gemini_client`を呼び出し、AI分析官にユーザーの意図を分析させます。
    3.  **【専門家召喚②】** その分析結果を、新専門家`protein_selector`に渡し、最適な商品の選定を依頼します。
    4.  **【専門家召喚③】** AIコピーライターに渡すための様々な情報を、新専門家`formatters`と`nutrition_data`を呼び出して準備させます。
    5.  **【専門家召喚④】** 準備したすべての情報を`gemini_client`に渡し、AIコピーライターに応答文を生成させます。
    6.  最終的な応答を解析し、`st.session_state`を更新して、`app.py`に処理を返します。

---
##### 《 新しく加わった専門家たち 》

##### `protein_selector.py` - データ分析官 (The Data Analyst)
*   **役割:** このアプリケーションの**新しい「論理的思考」の核**です。AI分析官から受け取ったユーザーの意図（`intent`）に基づき、Pandasを駆使してデータベースから最適な商品を**プログラム的に**選び出す、すべてのデータ分析ロジックを担当します。
*   **動作:** `select_products()`が呼び出されると、`intent`に応じて価格でソートしたり、特定のタグを持つ商品を抽出したりといった複雑な分析を行い、最終的な推薦リストと、なぜそれを選んだのかという「選定理由」を`chat_handler`に報告します。

##### `formatters.py` - テキスト整形職人 (The Text Artisan)
*   **役割:** チャット履歴やペルソナ情報といった、プログラムが扱うデータを、AIが最も理解しやすい美しいテキスト形式に**整形する**ことだけに責任を持ちます。
*   **動作:** `format_chat_history()`や`format_persona()`といった関数が、それぞれの目的に応じてテキストを整形し、`chat_handler`に納品します。

##### `nutrition_data.py` - 豆知識の司書 (The Librarian of Trivia)
*   **役割:** アプリケーションで使われるすべての「豆知識」を**保管・管理する**ことだけに責任を持ちます。
*   **動作:** `get_formatted_nutrition_tip()`が呼び出されると、ユーザーの意図（`intent`）に最も適した豆知識をデータベースから探し出し、`chat_handler`に提供します。

---
##### 《 従来からいる専門家たち 》

##### `ui_components.py` - UIの専門家 (The UI Specialist)
*   **役割:** ユーザーがブラウザで見る**全ての画面要素を描画する**ことだけに責任を持ちます。

##### `gemini_client.py` - AI通信の専門家 (The Communicator)
*   **役割:** GoogleのGemini APIとの**全ての通信**を専門に担当します。

##### `google_sheets_client.py` - データベースの専門家 (The Database Librarian)
*   **役割:** Googleスプレッドシート（私たちのデータベース）との**全ての通信**を専門に担当します。

#### `prompts/` - AIの魂 (The Soul)
*   **`system_prompt_analyzer.txt`:** AI分析官の思考回路です。
*   **`system_prompt_writer.txt`:** AIコピーライターの思考回路です。`chat_handler`と新しい専門家たちが準備した、より構造化された高品質な情報を基に、人間らしく説得力のある文章を生成するための、詳細な指示が記述されています。

---

この高度に専門化・分割されたアーキテクチャにより、各ファイルは自身の役割に完全に集中できるようになりました。これにより、**変更箇所が特定しやすく、デバッグも容易**になり、将来のさらなる機能拡張にも迅速に対応できる、極めてメンテナンス性の高いプロジェクトが実現されています。