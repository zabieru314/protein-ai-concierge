import gspread
import pandas as pd
import json
import os
import sys

# --- è¨­å®šé …ç›® ---
# ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ã€ã“ã®2ã¤ã®å¤‰æ•°ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
CREDENTIALS_PATH = 'credentials.json'
SPREADSHEET_NAME = 'ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³å•†å“ãƒªã‚¹ãƒˆ(AI)'
# ----------------

def final_diagnosis():
    """
    Google Sheetsã¸ã®æŽ¥ç¶šã‚’å¾¹åº•çš„ã«ãƒ†ã‚¹ãƒˆã—ã€å•é¡Œã®æ ¹æœ¬åŽŸå› ã‚’ç‰¹å®šã™ã‚‹è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã€‚
    """
    print("="*80)
    print("--- [START] Google Sheets æŽ¥ç¶šã®æœ€çµ‚è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™ ---")
    print("="*80)

    # --- ã‚¹ãƒ†ãƒƒãƒ—1: credentials.jsonãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª ---
    if not os.path.exists(CREDENTIALS_PATH):
        print(f"[FAIL] è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: '{CREDENTIALS_PATH}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        print("       > å¯¾ç­–: æ–°ã—ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’ 'credentials.json' ã«å¤‰æ›´ã—ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚")
        return

    print(f"[OK] ã‚¹ãƒ†ãƒƒãƒ—1: '{CREDENTIALS_PATH}' ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹ã—ã¾ã—ãŸã€‚")

    # --- ã‚¹ãƒ†ãƒƒãƒ—2: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã—ã¦ã®èªè¨¼ ---
    try:
        with open(CREDENTIALS_PATH, 'r') as f:
            creds_data = json.load(f)
            client_email = creds_data.get("client_email", "EmailãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        print(f"       > ä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: {client_email}")
        
        gc = gspread.service_account(filename=CREDENTIALS_PATH)
        print("[OK] ã‚¹ãƒ†ãƒƒãƒ—2: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚‹Googleã¸ã®èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚")
    except Exception as e:
        print(f"[FAIL] è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
        print(f"       > è©³ç´°: {e}")
        print("       > å¯¾ç­–: credentials.jsonãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Google Cloud Consoleã‹ã‚‰ã‚­ãƒ¼ã‚’å†ç™ºè¡Œã—ã¦ãã ã•ã„ã€‚")
        return

    # --- ã‚¹ãƒ†ãƒƒãƒ—3: ã€æœ€é‡è¦ã€‘ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªå…¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ— ---
    try:
        print("\n--- [DIAGNOSIS] ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªå…¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™... ---")
        
        # â–¼â–¼â–¼ã€ã“ã“ã‚’ä¸‰åº¦ç›®ã®æ­£ç›´ã§ä¿®æ­£ã—ã¾ã—ãŸã€‘â–¼â–¼â–¼
        # æ­£ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰ã¯ 'list_spreadsheet_files()' ã§ã™ã€‚
        # ã“ã‚Œã«ã‚ˆã‚Šã€Google Drive APIã‚’ä»‹ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
        spreadsheets = gc.list_spreadsheet_files()
        # â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
        
        if not spreadsheets:
            print("[WARN] è­¦å‘Š: ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã€ã©ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã§ã™ã€‚")
        else:
            print("       > ä»¥ä¸‹ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒç¢ºèªã§ãã¾ã—ãŸ:")
            # list_spreadsheet_files() ã¯è¾žæ›¸ã®ãƒªã‚¹ãƒˆã‚’è¿”ã™ãŸã‚ã€'name'ã‚­ãƒ¼ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã—ã¾ã™
            for i, ss_meta in enumerate(spreadsheets):
                print(f"         {i+1}. '{ss_meta['name']}' (æ›´æ–°æ—¥æ™‚: {ss_meta['modifiedTime']})")
        
        print("--- [DIAGNOSIS] ãƒªã‚¹ãƒˆã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸ ---\n")

    except Exception as e:
        print(f"[FAIL] ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
        print(f"       > è©³ç´°: {e}")
        return

    # --- ã‚¹ãƒ†ãƒƒãƒ—4: æŒ‡å®šã•ã‚ŒãŸåå‰ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³è©¦è¡Œ ---
    try:
        print(f"[ACTION] æŒ‡å®šã•ã‚ŒãŸåå‰ '{SPREADSHEET_NAME}' ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™...")
        spreadsheet = gc.open(SPREADSHEET_NAME)
        print("\n" + "="*80)
        print(f"ðŸŽ‰ [SUCCESS] ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ '{spreadsheet.title}' ã®ã‚ªãƒ¼ãƒ—ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸã€‚")
        print("="*80)
        print("       > ã“ã‚Œã§å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸã€‚é€šå¸¸ã® `streamlit run app.py` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")

    except gspread.exceptions.SpreadsheetNotFound:
        print("\n" + "="*80)
        print(f"[FAIL] æ ¹æœ¬åŽŸå› ç‰¹å®š: gspread.exceptions.SpreadsheetNotFound")
        print("="*80)
        print("ã€çµè«–ã€‘èªè¨¼ã¯æˆåŠŸã—ã¦ã„ã¾ã™ãŒã€æŒ‡å®šã•ã‚ŒãŸåå‰ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        print("        ã“ã‚Œã¯ã€Google Driveã®ã€Žå…±æœ‰è¨­å®šã€ã®å•é¡Œã§ã‚ã‚‹å¯èƒ½æ€§ãŒ99%ã§ã™ã€‚")
        print("\nã€æœ€çµ‚ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‘")
        print("â–¡ 1. ä¸Šè¨˜ã®ã€Žã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªå…¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒªã‚¹ãƒˆã€ã«ã€ç›®çš„ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ")
        print("   - NOã®å ´åˆ: å…±æœ‰è¨­å®šãŒã•ã‚Œã¦ã„ãªã„ã‹ã€é–“é•ã£ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å…±æœ‰ã—ã¦ã„ã¾ã™ã€‚")
        print("   - YESã®å ´åˆ: ã‚³ãƒ¼ãƒ‰å†…ã® SPREADSHEET_NAME ã¨ã€ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã•ã‚ŒãŸåå‰ãŒå®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ï¼ˆç©ºç™½ãªã©ï¼‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        print("\nâ–¡ 2. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰å…ˆã«ã€ä»¥ä¸‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã€Žé–²è¦§è€…ã€ã¨ã—ã¦è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ")
        print(f"   > {client_email}")
        print("\nâ–¡ 3. ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å†…ã«ã‚ã‚‹å ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè‡ªä½“ãŒãã®å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ")
        print("\nã€å¯¾ç­–ã€‘Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’å†åº¦ã€æ…Žé‡ã«ã”ç¢ºèªãã ã•ã„ã€‚")

    except Exception as e:
        print(f"[FAIL] äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ä¸­ã«åˆ¥ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
        print(f"       > è©³ç´°: {e}")

if __name__ == '__main__':
    final_diagnosis()